@functions {
    public string GetSeverityBadge(string severity)
    {
        return severity?.ToLower() switch
        {
            "low" => "bg-success",
            "medium" => "bg-warning",
            "high" => "bg-danger",
            "critical" => "bg-dark",
            _ => "bg-secondary"
        };
    }

    public string GetStatusBadge(string status)
    {
        return status?.ToLower() switch
        {
            "active" => "bg-danger",
            "resolved" => "bg-success",
            _ => "bg-secondary"
        };
    }
}

@model IEnumerable<Disaster>
@using GiftOfTheGiversApp.Extensions
@using System.Security.Claims

@{
    ViewData["Title"] = "Disaster Reports";

    // Get role-based flags from ViewData
    bool canEdit = ViewData["canEdit"] as bool? ?? false;
    bool canResolve = ViewData["canResolve"] as bool? ?? false;
    bool isAdmin = ViewData["isAdmin"] as bool? ?? false;
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Disaster Reports</h1>
    <a class="btn btn-primary" asp-action="Create">
        <i class="bi bi-plus-circle"></i> Report New Disaster
    </a>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (!Model.Any())
{
    <div class="alert alert-info">
        <h4>No disasters reported yet</h4>
        <p>Be the first to report a disaster in your area.</p>
        <a class="btn btn-primary" asp-action="Create">Report First Disaster</a>
    </div>
}
else
{
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h5 class="card-title">Active Disasters</h5>
                    <h2 class="card-text">@Model.Count(d => d.Status == "Active")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">Resolved</h5>
                    <h2 class="card-text">@Model.Count(d => d.Status == "Resolved")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">High Severity</h5>
                    <h2 class="card-text">@Model.Count(d => d.SeverityLevel == "High" || d.SeverityLevel == "Critical")</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">Total Reports</h5>
                    <h2 class="card-text">@Model.Count()</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Options -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Filter Disasters</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="all">All Statuses</option>
                            <option value="Active">Active</option>
                            <option value="Resolved">Resolved</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Severity</label>
                        <select class="form-select" id="severityFilter">
                            <option value="all">All Severities</option>
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Critical">Critical</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Disaster Type</label>
                        <select class="form-select" id="typeFilter">
                            <option value="all">All Types</option>
                            <option value="Flood">Flood</option>
                            <option value="Earthquake">Earthquake</option>
                            <option value="Fire">Fire</option>
                            <option value="Storm">Storm</option>
                            <option value="Drought">Drought</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="disastersTable">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Type</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Start Date</th>
                    <th>Affected</th>
                    <th>Reported By</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr class="disaster-row" data-status="@item.Status" data-severity="@item.SeverityLevel" data-type="@item.DisasterType">
                        <td>
                            <strong>@Html.DisplayFor(modelItem => item.Name)</strong>
                            <br />
                            <small class="text-muted">@item.Description.Truncate(50)</small>
                        </td>
                        <td>@Html.DisplayFor(modelItem => item.Location)</td>
                        <td>@Html.DisplayFor(modelItem => item.DisasterType)</td>
                        <td>
                            <span class="badge @GetSeverityBadge(item.SeverityLevel)">@item.SeverityLevel</span>
                        </td>
                        <td>
                            <span class="badge @GetStatusBadge(item.Status)">@item.Status</span>
                        </td>
                        <td>@item.StartDate.ToString("MMM dd, yyyy")</td>
                        <td>
                            @if (item.EstimatedAffected.HasValue)
                            {
                                <span>@item.EstimatedAffected.Value.ToString("N0")</span>
                            }
                            else
                            {
                                <span class="text-muted">Unknown</span>
                            }
                        </td>
                        <td>
                            <small>@item.ReportedBy?.FullName</small>
                            <br />
                            <small class="text-muted">@item.StartDate.ToString("MMM dd")</small>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a class="btn btn-sm btn-info" asp-action="Details" asp-route-id="@item.Id" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>

                                @if (canEdit)
                                {
                                    <a class="btn btn-sm btn-warning" asp-action="Edit" asp-route-id="@item.Id" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                }

                                @if (canResolve && item.Status == "Active")
                                {
                                    <a class="btn btn-sm btn-success" asp-action="Resolve" asp-route-id="@item.Id" title="Mark Resolved">
                                        <i class="bi bi-check-circle"></i>
                                    </a>
                                }

                                @if (isAdmin)
                                {
                                    <a class="btn btn-sm btn-danger" asp-action="Delete" asp-route-id="@item.Id" title="Delete (Admin Only)">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Summary Information -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Recent Activity</h6>
                            <ul class="list-unstyled">
                                @foreach (var recent in Model.OrderByDescending(d => d.StartDate).Take(3))
                                {
                                    <li>
                                        <small>
                                            <span class="badge @GetStatusBadge(recent.Status)">@recent.Status</span>
                                            @recent.Name - @recent.StartDate.ToString("MMM dd")
                                        </small>
                                    </li>
                                }
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Severity Distribution</h6>
                            <ul class="list-unstyled">
                                <li><small>Critical: <span class="badge bg-dark">@Model.Count(d => d.SeverityLevel == "Critical")</span></small></li>
                                <li><small>High: <span class="badge bg-danger">@Model.Count(d => d.SeverityLevel == "High")</span></small></li>
                                <li><small>Medium: <span class="badge bg-warning">@Model.Count(d => d.SeverityLevel == "Medium")</span></small></li>
                                <li><small>Low: <span class="badge bg-success">@Model.Count(d => d.SeverityLevel == "Low")</span></small></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Filter functionality
        document.addEventListener('DOMContentLoaded', function () {
            const statusFilter = document.getElementById('statusFilter');
            const severityFilter = document.getElementById('severityFilter');
            const typeFilter = document.getElementById('typeFilter');
            const disasterRows = document.querySelectorAll('.disaster-row');

            function filterDisasters() {
                const statusValue = statusFilter.value;
                const severityValue = severityFilter.value;
                const typeValue = typeFilter.value;

                disasterRows.forEach(row => {
                    const rowStatus = row.getAttribute('data-status');
                    const rowSeverity = row.getAttribute('data-severity');
                    const rowType = row.getAttribute('data-type');

                    const statusMatch = statusValue === 'all' || rowStatus === statusValue;
                    const severityMatch = severityValue === 'all' || rowSeverity === severityValue;
                    const typeMatch = typeValue === 'all' || rowType === typeValue;

                    if (statusMatch && severityMatch && typeMatch) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            statusFilter.addEventListener('change', filterDisasters);
            severityFilter.addEventListener('change', filterDisasters);
            typeFilter.addEventListener('change', filterDisasters);

            // Auto-dismiss alerts after 5 seconds
            setTimeout(function () {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });

        // Quick status update for coordinators/admins
        function quickResolve(disasterId, disasterName) {
            if (confirm(`Mark "${disasterName}" as resolved?`)) {
                window.location.href = `/Disasters/Resolve/${disasterId}`;
            }
        }

        // Auto-dismiss alerts after 5 seconds
        setTimeout(function () {
            $('.alert').alert('close');
        }, 5000);
    </script>
}
